<!DOCTYPE html>
<html>
<head>
    <title>StoryEstimateChanges</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    items:[
        {
            xtype: 'container',
            id: 'selectbox'
        },
        {
            xtype: 'container',
            id: 'htmlbox'
        }
    ],

    _update: function() {

        var data = this.usStore.data.items;

        var storyId = data[0].get('FormattedID');
        var currentEstimate = data[0].get('PlanEstimate');

        _.each(data, function(record) {
            if ( record.get('FormattedID') !== storyId)
            {
                storyId = record.get('FormattedID');
                currentEstimate = record.get('PlanEstimate');
            }
            else if ( record.get('PlanEstimate') !== currentEstimate){
                if (currentEstimate !== 0){

                    Ext.getCmp('htmlbox').add(
                        {
                            xtype: 'component',
                            html: record.get('FormattedID') + ' changed from ' + currentEstimate + ' to ' + record.get('PlanEstimate') + ' at ' + record.get('_ValidFrom')
                        }
                    );
                }
                currentEstimate = record.get('PlanEstimate');
            }
        });
    },

    usStore: null,

    usStoreConfig: function(app){

    console.log(this.getContext());

        return {
            context: this.getContext().getDataContext(),
            autoLoad: false,
            id: 'usStore',
            fetch: ['FormattedID', 'Name'],
            hydrate: ['FormattedID', 'Name' ],
            filters:  [
                        {
                            property: '_TypeHierarchy',
                            operator: 'in',
                            value: [ 'HierarchicalRequirement', 'Defect' ]
                        }
            ],
            pageSize: 200

        };
    },

    launch: function() {

        var app = this;

        app.usStore = Ext.create('Rally.data.lookback.SnapshotStore',  app.usStoreConfig(app) );

        var iterationSelector = Ext.create( 'Rally.ui.combobox.IterationComboBox', {
            id: 'selectIteration',
            margin: 10,
            listeners: {
                ready: function() {
                    app.usStore.load({
                        callback: function(records, operation, success) {
                            app._update();
                        }
                    });
                },
                select: function() {
                    Ext.getCmp('htmlbox').removeAll();
                    app.usStore.destroy();
                    app.usStore = Ext.create('Rally.data.lookback.SnapshotStore', app.usStoreConfig(app) );
                    app.usStore.load({
                        callback: function(records, operation, success) {
                            app._update();
                        }
                    });
                }

            }
        });
Ext.util.Observable.capture( iterationSelector, function(event) {
    console.log(iterationSelector.id, event, arguments);
});
        Ext.getCmp('selectbox').add(iterationSelector);

    }
});


            Rally.launchApp('CustomApp', {
                name:"StoryEstimateChanges",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
